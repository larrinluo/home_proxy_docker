# 第一阶段本地开发补充事项清单

## 文档说明

本文档列出第一阶段（本地开发阶段）需要补充的所有事项，以确保能够启动自动化开发、测试闭环。所有事项按照优先级和类别进行分类，便于有序实施。

---

## 一、测试框架配置（P0 - 必须）

### 1.1 后端测试框架配置

**文件：`server/back-end/package.json`**

需要添加的测试脚本和依赖：

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:unit": "jest tests/unit",
    "test:integration": "jest tests/integration",
    "test:setup": "node scripts/test-setup.js",
    "test:cleanup": "node scripts/test-cleanup.js"
  },
  "devDependencies": {
    "jest": "^29.7.0",
    "supertest": "^6.3.3",
    "@types/jest": "^29.5.5"
  }
}
```

**文件：`server/back-end/jest.config.js`**

```javascript
module.exports = {
  testEnvironment: 'node',
  testMatch: ['**/tests/**/*.test.js'],
  setupFilesAfterEnv: ['<rootDir>/tests/setup.js'],
  collectCoverageFrom: [
    '**/*.js',
    '!**/node_modules/**',
    '!**/tests/**',
    '!**/scripts/**'
  ],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70
    }
  },
  testTimeout: 10000
};
```

**文件：`server/back-end/tests/setup.js`**

```javascript
// 测试环境全局设置
const { initTestDB, cleanupTestDB } = require('./helpers/db-helper');

beforeAll(async () => {
  // 初始化测试数据库
  await initTestDB();
});

afterAll(async () => {
  // 清理测试数据库
  await cleanupTestDB();
});

// 每个测试前清理数据
beforeEach(async () => {
  // 清理测试数据（可选，根据需要）
});
```

### 1.2 前端测试框架配置

**文件：`server/front-end/package.json`**

```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage",
    "test:unit": "vitest tests/unit",
    "test:e2e": "playwright test"
  },
  "devDependencies": {
    "vitest": "^1.0.0",
    "@vue/test-utils": "^2.4.0",
    "playwright": "^1.40.0",
    "@playwright/test": "^1.40.0"
  }
}
```

**文件：`server/front-end/vitest.config.js`**

```javascript
import { defineConfig } from 'vitest/config';
import vue from '@vitejs/plugin-vue';

export default defineConfig({
  plugins: [vue()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: ['./tests/setup.js']
  }
});
```

**文件：`server/front-end/playwright.config.js`**

```javascript
module.exports = {
  testDir: './tests/e2e',
  use: {
    baseURL: 'http://localhost:5173',
    apiURL: 'http://t58:3100'
  },
  webServer: {
    command: 'npm run dev',
    port: 5173,
    reuseExistingServer: !process.env.CI
  }
};
```

---

## 二、测试目录结构（P0 - 必须）

### 2.1 后端测试目录结构

```
server/back-end/
├── tests/
│   ├── setup.js                    # 测试环境设置
│   ├── fixtures/                   # 测试数据文件
│   │   ├── users.json
│   │   ├── jump-servers.json
│   │   ├── proxy-services.json
│   │   ├── host-configs.json
│   │   └── system-configs.json
│   ├── helpers/                    # 测试辅助函数
│   │   ├── db-helper.js           # 数据库操作辅助
│   │   ├── auth-helper.js         # 认证辅助函数
│   │   ├── ssh-mock.js            # SSH Mock服务
│   │   └── test-utils.js          # 通用测试工具
│   ├── unit/                       # 单元测试
│   │   ├── db.test.js
│   │   ├── utils.test.js
│   │   └── pac-generator.test.js
│   └── integration/                # 集成测试
│       ├── auth.test.js
│       ├── users.test.js
│       ├── proxy-services.test.js
│       ├── host-configs.test.js
│       ├── pac-config.test.js
│       └── system-configs.test.js
├── jest.config.js
└── package.json
```

### 2.2 前端测试目录结构

```
server/front-end/
├── tests/
│   ├── setup.js                    # 测试环境设置
│   ├── fixtures/                   # 测试数据
│   │   └── mock-data.js
│   ├── unit/                       # 组件单元测试
│   │   ├── components/
│   │   │   ├── LoginForm.test.js
│   │   │   └── ProxyCard.test.js
│   │   └── utils/
│   │       └── api.test.js
│   └── e2e/                        # E2E测试
│       ├── auth.spec.js
│       ├── proxy-services.spec.js
│       └── host-configs.spec.js
├── vitest.config.js
├── playwright.config.js
└── package.json
```

---

## 三、测试数据管理（P0 - 必须）

### 3.1 测试数据文件

**文件：`server/back-end/tests/fixtures/users.json`**

```json
{
  "users": [
    {
      "username": "testuser1",
      "password": "Test123456",
      "email": "testuser1@example.com",
      "description": "基础功能测试用户"
    },
    {
      "username": "testuser2",
      "password": "Test123456",
      "email": "testuser2@example.com",
      "description": "并发测试用户"
    },
    {
      "username": "admin",
      "password": "Admin123456",
      "email": "admin@example.com",
      "description": "管理员测试用户"
    }
  ]
}
```

**文件：`server/back-end/tests/fixtures/jump-servers.json`**

```json
{
  "jump_servers": [
    {
      "name": "测试跳板1",
      "host": "43.163.237.183",
      "port": 22,
      "username": "larrin",
      "password": "TheDog@01",
      "description": "代理服务测试用跳板服务器"
    },
    {
      "name": "测试跳板2",
      "host": "43.153.100.84",
      "port": 22,
      "username": "larrin",
      "password": "TheDog@01",
      "description": "多代理服务测试用跳板服务器"
    }
  ]
}
```

**文件：`server/back-end/tests/fixtures/proxy-services.json`**

```json
{
  "proxy_services": [
    {
      "name": "测试代理服务1",
      "jump_host": "43.163.237.183",
      "jump_port": 22,
      "jump_username": "larrin",
      "password": "TheDog@01",
      "hosts": ["google.com", "youtube.com"]
    }
  ]
}
```

### 3.2 测试数据库初始化脚本

**文件：`server/back-end/scripts/test-setup.js`**

```javascript
const db = require('../db');
const fs = require('fs');
const path = require('path');

const testData = {
  users: require('../tests/fixtures/users.json').users,
  jumpServers: require('../tests/fixtures/jump-servers.json').jump_servers,
  systemConfigs: [
    { key: 'register_enabled', value: 'true', description: '用户注册开关' }
  ]
};

async function initTestDB() {
  try {
    // 使用测试数据库
    process.env.DATABASE_PATH = './data/test-database.db';
    
    // 初始化数据库（创建表）
    await db.init();
    
    // 插入系统配置
    for (const config of testData.systemConfigs) {
      await db.insertSystemConfig(config.key, config.value, config.description);
    }
    
    // 插入测试用户（密码需要加密）
    const bcrypt = require('bcrypt');
    for (const user of testData.users) {
      const hashedPassword = await bcrypt.hash(user.password, 10);
      await db.insertUser({
        username: user.username,
        password_hash: hashedPassword,
        email: user.email
      });
    }
    
    console.log('✅ 测试数据库初始化完成');
  } catch (error) {
    console.error('❌ 测试数据库初始化失败:', error);
    process.exit(1);
  }
}

if (require.main === module) {
  initTestDB();
}

module.exports = { initTestDB };
```

### 3.3 测试数据库清理脚本

**文件：`server/back-end/scripts/test-cleanup.js`**

```javascript
const db = require('../db');
const fs = require('fs');
const path = require('path');

async function cleanupTestDB() {
  try {
    // 删除测试数据库文件
    const dbPath = './data/test-database.db';
    if (fs.existsSync(dbPath)) {
      fs.unlinkSync(dbPath);
      console.log('✅ 测试数据库已清理');
    }
    
    // 清理测试生成的SSH密钥
    const sshKeysDir = './data/ssh-keys';
    if (fs.existsSync(sshKeysDir)) {
      const files = fs.readdirSync(sshKeysDir);
      files.forEach(file => {
        if (file.startsWith('test-')) {
          fs.unlinkSync(path.join(sshKeysDir, file));
        }
      });
      console.log('✅ 测试SSH密钥已清理');
    }
  } catch (error) {
    console.error('❌ 测试环境清理失败:', error);
  }
}

if (require.main === module) {
  cleanupTestDB();
}

module.exports = { cleanupTestDB };
```

---

## 四、测试辅助函数（P0 - 必须）

### 4.1 数据库操作辅助函数

**文件：`server/back-end/tests/helpers/db-helper.js`**

```javascript
const db = require('../../db');
const testData = require('../fixtures/users.json');

async function initTestDB() {
  // 设置测试数据库路径
  process.env.DATABASE_PATH = './data/test-database.db';
  
  // 初始化数据库
  await db.init();
  
  // 插入测试数据
  await insertTestUsers();
  await insertTestSystemConfigs();
}

async function cleanupTestDB() {
  // 清理所有测试数据
  await db.query('DELETE FROM users WHERE username LIKE "test%"');
  await db.query('DELETE FROM proxy_services');
  await db.query('DELETE FROM host_configs');
  await db.query('UPDATE system_configs SET value = "true" WHERE key = "register_enabled"');
}

async function insertTestUsers() {
  const bcrypt = require('bcrypt');
  for (const user of testData.users) {
    const hashedPassword = await bcrypt.hash(user.password, 10);
    await db.insertUser({
      username: user.username,
      password_hash: hashedPassword,
      email: user.email
    });
  }
}

async function insertTestSystemConfigs() {
  await db.insertSystemConfig('register_enabled', 'true', '用户注册开关');
}

async function getTestUser(username) {
  return await db.getUserByUsername(username);
}

module.exports = {
  initTestDB,
  cleanupTestDB,
  insertTestUsers,
  insertTestSystemConfigs,
  getTestUser
};
```

### 4.2 认证辅助函数

**文件：`server/back-end/tests/helpers/auth-helper.js`**

```javascript
const request = require('supertest');
const app = require('../../server');

/**
 * 登录并返回Session Cookie
 */
async function login(username, password) {
  const response = await request(app)
    .post('/api/v1/auth/login')
    .send({ username, password });
  
  if (response.status !== 200) {
    throw new Error(`登录失败: ${response.body.message}`);
  }
  
  // 提取Cookie
  const cookies = response.headers['set-cookie'];
  const sessionCookie = cookies.find(cookie => cookie.startsWith('connect.sid'));
  
  return {
    cookie: sessionCookie,
    user: response.body.data.user
  };
}

/**
 * 创建认证请求
 */
function authenticatedRequest(method, url) {
  return request(app)[method.toLowerCase()](url);
}

/**
 * 设置认证Cookie
 */
function setAuthCookie(request, cookie) {
  return request.set('Cookie', cookie);
}

module.exports = {
  login,
  authenticatedRequest,
  setAuthCookie
};
```

### 4.3 SSH Mock服务

**文件：`server/back-end/tests/helpers/ssh-mock.js`**

```javascript
const EventEmitter = require('events');

/**
 * SSH连接Mock类
 * 用于模拟SSH连接，避免依赖真实跳板服务器
 */
class SSHMock extends EventEmitter {
  constructor(options) {
    super();
    this.options = options;
    this.connected = false;
  }
  
  connect() {
    return new Promise((resolve, reject) => {
      // 模拟连接延迟
      setTimeout(() => {
        // 模拟连接成功/失败
        if (this.options.shouldFail) {
          reject(new Error('SSH连接失败'));
        } else {
          this.connected = true;
          this.emit('ready');
          resolve();
        }
      }, 100);
    });
  }
  
  exec(command, callback) {
    if (!this.connected) {
      callback(new Error('未连接'));
      return;
    }
    
    // 模拟命令执行
    setTimeout(() => {
      if (command.includes('mkdir')) {
        callback(null, { stdout: '', stderr: '' });
      } else if (command.includes('cat')) {
        callback(null, { stdout: 'authorized_keys_content', stderr: '' });
      } else {
        callback(null, { stdout: 'success', stderr: '' });
      }
    }, 50);
  }
  
  end() {
    this.connected = false;
    this.emit('close');
  }
}

/**
 * 创建SSH Mock实例
 */
function createSSHMock(options = {}) {
  return new SSHMock(options);
}

/**
 * Mock SSH2模块
 */
function mockSSH2() {
  const originalSSH2 = require('ssh2');
  
  // 替换Client类
  originalSSH2.Client = class extends EventEmitter {
    constructor() {
      super();
      this.connected = false;
    }
    
    connect(config) {
      return new Promise((resolve, reject) => {
        setTimeout(() => {
          if (config.host === 'invalid-host') {
            reject(new Error('无法连接到跳板服务器'));
          } else {
            this.connected = true;
            this.emit('ready');
            resolve();
          }
        }, 100);
      });
    }
    
    exec(command, callback) {
      if (!this.connected) {
        callback(new Error('未连接'));
        return;
      }
      
      setTimeout(() => {
        if (command.includes('mkdir')) {
          callback(null, { stdout: '', stderr: '' });
        } else if (command.includes('cat')) {
          callback(null, { stdout: 'existing_keys', stderr: '' });
        } else {
          callback(null, { stdout: 'success', stderr: '' });
        }
      }, 50);
    }
    
    end() {
      this.connected = false;
      this.emit('close');
    }
  };
  
  return originalSSH2;
}

module.exports = {
  createSSHMock,
  mockSSH2
};
```

---

## 五、API自动化测试示例（P0 - 必须）

### 5.1 用户认证API测试

**文件：`server/back-end/tests/integration/auth.test.js`**

```javascript
const request = require('supertest');
const app = require('../../server');
const { initTestDB, cleanupTestDB } = require('../helpers/db-helper');
const { login } = require('../helpers/auth-helper');

describe('用户认证API', () => {
  beforeAll(async () => {
    await initTestDB();
  });
  
  afterAll(async () => {
    await cleanupTestDB();
  });
  
  describe('POST /api/v1/auth/register', () => {
    it('TC-AUTH-001: 正常注册流程', async () => {
      const response = await request(app)
        .post('/api/v1/auth/register')
        .send({
          username: 'newuser',
          password: 'Test123456',
          email: 'newuser@example.com'
        });
      
      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.data.username).toBe('newuser');
      expect(response.body.data).not.toHaveProperty('password');
    });
    
    it('TC-AUTH-002: 用户名已存在', async () => {
      const response = await request(app)
        .post('/api/v1/auth/register')
        .send({
          username: 'testuser1',
          password: 'Test123456'
        });
      
      expect(response.status).toBe(409);
      expect(response.body.success).toBe(false);
      expect(response.body.error.message).toContain('用户名已存在');
    });
    
    it('TC-AUTH-004: 参数验证失败', async () => {
      const response = await request(app)
        .post('/api/v1/auth/register')
        .send({
          username: 'ab',
          password: '123'
        });
      
      expect(response.status).toBe(400);
      expect(response.body.success).toBe(false);
    });
  });
  
  describe('POST /api/v1/auth/login', () => {
    it('TC-AUTH-005: 正常登录流程', async () => {
      const response = await request(app)
        .post('/api/v1/auth/login')
        .send({
          username: 'testuser1',
          password: 'Test123456'
        });
      
      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.data.user.username).toBe('testuser1');
      expect(response.headers['set-cookie']).toBeDefined();
    });
    
    it('TC-AUTH-006: 用户名或密码错误', async () => {
      const response = await request(app)
        .post('/api/v1/auth/login')
        .send({
          username: 'testuser1',
          password: 'WrongPassword'
        });
      
      expect(response.status).toBe(401);
      expect(response.body.success).toBe(false);
      expect(response.body.error.message).toContain('用户名或密码错误');
    });
  });
  
  describe('POST /api/v1/auth/logout', () => {
    it('TC-AUTH-009: 正常注销流程', async () => {
      // 先登录
      const { cookie } = await login('testuser1', 'Test123456');
      
      // 注销
      const response = await request(app)
        .post('/api/v1/auth/logout')
        .set('Cookie', cookie);
      
      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
    });
  });
  
  describe('GET /api/v1/auth/me', () => {
    it('TC-AUTH-011: 获取已登录用户信息', async () => {
      const { cookie } = await login('testuser1', 'Test123456');
      
      const response = await request(app)
        .get('/api/v1/auth/me')
        .set('Cookie', cookie);
      
      expect(response.status).toBe(200);
      expect(response.body.data.username).toBe('testuser1');
      expect(response.body.data).not.toHaveProperty('password');
    });
    
    it('TC-AUTH-012: 未登录时获取用户信息', async () => {
      const response = await request(app)
        .get('/api/v1/auth/me');
      
      expect(response.status).toBe(401);
    });
  });
});
```

### 5.2 代理服务API测试

**文件：`server/back-end/tests/integration/proxy-services.test.js`**

```javascript
const request = require('supertest');
const app = require('../../server');
const { initTestDB, cleanupTestDB } = require('../helpers/db-helper');
const { login } = require('../helpers/auth-helper');
const { mockSSH2 } = require('../helpers/ssh-mock');

describe('代理服务管理API', () => {
  let authCookie;
  
  beforeAll(async () => {
    await initTestDB();
    const loginResult = await login('testuser1', 'Test123456');
    authCookie = loginResult.cookie;
    
    // Mock SSH2
    mockSSH2();
  });
  
  afterAll(async () => {
    await cleanupTestDB();
  });
  
  describe('POST /api/v1/proxy-services', () => {
    it('TC-PROXY-001: 正常创建代理服务流程', async () => {
      const response = await request(app)
        .post('/api/v1/proxy-services')
        .set('Cookie', authCookie)
        .send({
          name: '测试代理1',
          jump_host: '43.163.237.183',
          jump_port: 22,
          jump_username: 'larrin',
          password: 'TheDog@01',
          hosts: ['google.com', 'youtube.com']
        });
      
      expect(response.status).toBe(201);
      expect(response.body.success).toBe(true);
      expect(response.body.data.name).toBe('测试代理1');
      expect(response.body.data.proxy_port).toBeGreaterThanOrEqual(11081);
      expect(response.body.data.proxy_port).toBeLessThanOrEqual(11082);
      expect(response.body.data.status).toBe('running');
    });
    
    it('TC-PROXY-002: SSH连接失败', async () => {
      const response = await request(app)
        .post('/api/v1/proxy-services')
        .set('Cookie', authCookie)
        .send({
          name: '测试代理2',
          jump_host: 'invalid-host',
          jump_port: 22,
          jump_username: 'user',
          password: 'password'
        });
      
      expect(response.status).toBe(502);
      expect(response.body.success).toBe(false);
      expect(response.body.error.message).toContain('无法连接到跳板服务器');
    });
  });
  
  describe('GET /api/v1/proxy-services', () => {
    it('TC-PROXY-006: 获取代理服务列表', async () => {
      const response = await request(app)
        .get('/api/v1/proxy-services')
        .set('Cookie', authCookie);
      
      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(Array.isArray(response.body.data.items)).toBe(true);
    });
  });
});
```

---

## 六、单元测试示例（P1 - 重要）

### 6.1 数据库操作单元测试

**文件：`server/back-end/tests/unit/db.test.js`**

```javascript
const db = require('../../db');
const { initTestDB, cleanupTestDB } = require('../helpers/db-helper');

describe('数据库操作', () => {
  beforeAll(async () => {
    await initTestDB();
  });
  
  afterAll(async () => {
    await cleanupTestDB();
  });
  
  describe('用户操作', () => {
    it('TC-INT-018: 数据库CRUD操作', async () => {
      // Create
      const user = await db.insertUser({
        username: 'test_crud',
        password_hash: 'hashed_password',
        email: 'test@example.com'
      });
      expect(user.id).toBeDefined();
      
      // Read
      const foundUser = await db.getUserByUsername('test_crud');
      expect(foundUser.username).toBe('test_crud');
      
      // Update
      await db.updateUser(user.id, { email: 'updated@example.com' });
      const updatedUser = await db.getUserByUsername('test_crud');
      expect(updatedUser.email).toBe('updated@example.com');
      
      // Delete
      await db.deleteUser(user.id);
      const deletedUser = await db.getUserByUsername('test_crud');
      expect(deletedUser).toBeNull();
    });
  });
});
```

### 6.2 PAC配置生成单元测试

**文件：`server/back-end/tests/unit/pac-generator.test.js`**

```javascript
const pacGenerator = require('../../services/pac-generator');

describe('PAC配置生成', () => {
  it('TC-PAC-001: 生成PAC配置', () => {
    const hostConfigs = [
      {
        id: 1,
        proxy_service: {
          id: 1,
          proxy_port: 11081,
          status: 'running'
        },
        hosts: ['google.com', 'youtube.com']
      }
    ];
    
    const pacConfig = pacGenerator.generate(hostConfigs, '192.168.1.4');
    
    expect(pacConfig.proxyRules).toBeDefined();
    expect(Array.isArray(pacConfig.proxyRules)).toBe(true);
    expect(pacConfig.proxyRules[0].domains).toContain('google.com');
    expect(pacConfig.proxyRules[0].proxy).toBe('SOCKS5 192.168.1.4:11081');
  });
  
  it('TC-PAC-002: 只包含运行中的代理服务', () => {
    const hostConfigs = [
      {
        id: 1,
        proxy_service: {
          id: 1,
          proxy_port: 11081,
          status: 'running'
        },
        hosts: ['google.com']
      },
      {
        id: 2,
        proxy_service: {
          id: 2,
          proxy_port: 11082,
          status: 'stopped'
        },
        hosts: ['facebook.com']
      }
    ];
    
    const pacConfig = pacGenerator.generate(hostConfigs, '192.168.1.4');
    
    expect(pacConfig.proxyRules.length).toBe(1);
    expect(pacConfig.proxyRules[0].domains).toContain('google.com');
  });
});
```

---

## 七、E2E测试示例（P1 - 重要）

### 7.1 前端E2E测试

**文件：`server/front-end/tests/e2e/auth.spec.js`**

```javascript
import { test, expect } from '@playwright/test';

test.describe('用户认证', () => {
  test('TC-AUTH-001: 正常注册流程', async ({ page }) => {
    await page.goto('/');
    
    // 点击注册
    await page.click('text=注册');
    
    // 填写注册信息
    await page.fill('input[name="username"]', 'newuser');
    await page.fill('input[name="password"]', 'Test123456');
    await page.fill('input[name="email"]', 'newuser@example.com');
    
    // 提交
    await page.click('button[type="submit"]');
    
    // 验证跳转到登录页或主页面
    await expect(page).toHaveURL(/\/login|\/dashboard/);
  });
  
  test('TC-AUTH-005: 正常登录流程', async ({ page }) => {
    await page.goto('/login');
    
    // 填写登录信息
    await page.fill('input[name="username"]', 'testuser1');
    await page.fill('input[name="password"]', 'Test123456');
    
    // 提交
    await page.click('button[type="submit"]');
    
    // 验证跳转到主页面
    await expect(page).toHaveURL('/dashboard');
    
    // 验证显示用户信息
    await expect(page.locator('.user-info')).toContainText('testuser1');
  });
});
```

---

## 八、测试环境配置（P0 - 必须）

### 8.1 测试环境变量文件

**文件：`server/back-end/.env.test`**

```bash
NODE_ENV=test
PORT=3101
DATABASE_PATH=./data/test-database.db
SESSION_SECRET=test-session-secret-key
PROXY_HOST=t58
PROXY_PORT=8090
LOG_LEVEL=error
```

### 8.2 测试启动脚本

**文件：`server/back-end/scripts/test-start.js`**

```javascript
const { spawn } = require('child_process');
const { initTestDB } = require('../tests/helpers/db-helper');

async function startTestServer() {
  // 初始化测试数据库
  await initTestDB();
  
  // 设置测试环境变量
  process.env.NODE_ENV = 'test';
  process.env.PORT = '3101';
  process.env.DATABASE_PATH = './data/test-database.db';
  
  // 启动测试服务器
  const server = require('../server');
  
  return new Promise((resolve) => {
    server.listen(3101, () => {
      console.log('✅ 测试服务器已启动: http://localhost:3101');
      resolve(server);
    });
  });
}

if (require.main === module) {
  startTestServer().catch(console.error);
}

module.exports = { startTestServer };
```

---

## 九、代码质量工具配置（P1 - 重要）

### 9.1 ESLint配置

**文件：`server/back-end/.eslintrc.js`**

```javascript
module.exports = {
  env: {
    node: true,
    es2021: true,
    jest: true
  },
  extends: ['eslint:recommended'],
  parserOptions: {
    ecmaVersion: 2021,
    sourceType: 'module'
  },
  rules: {
    'no-console': 'warn',
    'no-unused-vars': 'error'
  }
};
```

### 9.2 Prettier配置

**文件：`server/back-end/.prettierrc`**

```json
{
  "semi": true,
  "singleQuote": true,
  "tabWidth": 2,
  "trailingComma": "es5"
}
```

---

## 十、测试报告生成（P2 - 可选）

### 10.1 Jest测试报告配置

在 `jest.config.js` 中添加：

```javascript
module.exports = {
  // ... 其他配置
  reporters: [
    'default',
    ['jest-html-reporters', {
      publicPath: './test-reports',
      filename: 'test-report.html',
      expand: true
    }]
  ]
};
```

### 10.2 测试覆盖率报告

```bash
# 生成覆盖率报告
npm run test:coverage

# 报告位置: coverage/lcov-report/index.html
```

---

## 十一、实施优先级和时间估算

### P0 - 必须（立即实施）

1. **测试框架配置**（1天）
   - Jest配置（后端）
   - Vitest配置（前端）
   - Playwright配置（E2E）

2. **测试目录结构**（0.5天）
   - 创建测试目录
   - 创建测试文件模板

3. **测试数据管理**（1天）
   - 测试数据文件
   - 数据库初始化脚本
   - 数据库清理脚本

4. **测试辅助函数**（2天）
   - 数据库操作辅助
   - 认证辅助函数
   - SSH Mock服务

5. **API自动化测试**（3-5天）
   - 用户认证API测试
   - 代理服务API测试
   - Host配置API测试
   - PAC配置API测试

**小计：7.5-9.5天**

### P1 - 重要（第一周内完成）

1. **单元测试**（2-3天）
   - 数据库操作测试
   - 业务逻辑测试
   - PAC生成测试

2. **E2E测试**（2-3天）
   - 用户认证流程
   - 代理服务管理流程
   - Host配置管理流程

3. **代码质量工具**（0.5天）
   - ESLint配置
   - Prettier配置

**小计：4.5-6.5天**

### P2 - 可选（第二周完成）

1. **测试报告生成**（1天）
   - HTML测试报告
   - 覆盖率报告

2. **性能测试自动化**（2天）
   - API性能测试脚本
   - 并发测试脚本

**小计：3天**

---

## 十二、检查清单

### 环境准备
- [ ] Node.js 18+ 已安装
- [ ] npm 9+ 已安装
- [ ] 测试数据库目录已创建
- [ ] 测试SSH密钥目录已创建

### 测试框架
- [ ] Jest已安装并配置（后端）
- [ ] Vitest已安装并配置（前端）
- [ ] Playwright已安装并配置（E2E）
- [ ] Supertest已安装（API测试）

### 测试数据
- [ ] 测试用户数据文件已创建
- [ ] 测试跳板服务器数据文件已创建
- [ ] 测试代理服务数据文件已创建
- [ ] 测试数据库初始化脚本已实现
- [ ] 测试数据库清理脚本已实现

### 测试辅助
- [ ] 数据库操作辅助函数已实现
- [ ] 认证辅助函数已实现
- [ ] SSH Mock服务已实现
- [ ] 测试工具函数已实现

### 测试用例
- [ ] 用户认证API测试已实现
- [ ] 用户管理API测试已实现
- [ ] 代理服务API测试已实现
- [ ] Host配置API测试已实现
- [ ] PAC配置API测试已实现
- [ ] 系统配置API测试已实现

### 代码质量
- [ ] ESLint已配置
- [ ] Prettier已配置
- [ ] 代码格式化脚本已添加

---

## 十三、下一步行动

1. **立即开始**：创建测试框架配置和目录结构
2. **第一周**：完成P0和P1事项
3. **第二周**：完成P2事项，优化测试覆盖率
4. **持续改进**：根据实际开发情况调整测试策略

---

**文档版本**：1.0  
**创建日期**：2024年  
**维护者**：开发团队
